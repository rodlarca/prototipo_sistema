{% extends "base.html" %}
{% block title %}Monitoreo ILO{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
  <div>
    <h1 class="h3 mb-1">Monitoreo ILO</h1>
    <div class="text-muted small">
      Gráficos simulados (CPU, ancho de banda, errores y estados).
      Servidor en serie temporal: <span class="fw-semibold">{{ servidor_actual }}</span>
    </div>
  </div>

  <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">Volver al inicio</a>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white fw-semibold">
        CPU y ancho de banda en el tiempo ({{ servidor_actual }})
      </div>
      <div class="card-body">
        <canvas id="chartLinea"></canvas>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white fw-semibold">
        Errores totales por servidor
      </div>
      <div class="card-body">
        <canvas id="chartBarrasErrores"></canvas>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">
        CPU promedio por servidor
      </div>
      <div class="card-body">
        <canvas id="chartCpuPromedio"></canvas>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">
        Distribución de estados (OK / WARNING / CRITICAL)
      </div>
      <div class="card-body">
        <canvas id="chartEstados"></canvas>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-white fw-semibold">
        Errores en el tiempo ({{ servidor_actual }})
      </div>
      <div class="card-body">
        <canvas id="chartErroresTiempo"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // (tu JS intacto)
  const labels = {{ labels|tojson }};
  const cpuData = {{ cpu|tojson }};
  const bwData = {{ bw|tojson }};
  const erroresData = {{ errores|tojson }};
  const memoriaData = {{ memoria|tojson }};

  const servidoresErrores = {{ servidores|tojson }};
  const erroresTotales = {{ errores_totales|tojson }};

  const servidoresCpu = {{ servidores_cpu|tojson }};
  const cpuPromedios = {{ cpu_promedios|tojson }};

  const estadosLabels = {{ estados_labels|tojson }};
  const estadosCounts = {{ estados_counts|tojson }};

  const ctxLinea = document.getElementById('chartLinea').getContext('2d');
  new Chart(ctxLinea, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'CPU (%)', data: cpuData, yAxisID: 'y', tension: 0.3 },
        { label: 'Ancho de banda (Mbps)', data: bwData, yAxisID: 'y1', borderDash: [5,5], tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      plugins: { legend: { position: 'top' } },
      scales: {
        y: { type: 'linear', position: 'left', title: { display: true, text: 'CPU (%)' } },
        y1: { type: 'linear', position: 'right', title: { display: true, text: 'Ancho de banda (Mbps)' }, grid: { drawOnChartArea: false } }
      }
    }
  });

  const ctxBarrasErrores = document.getElementById('chartBarrasErrores').getContext('2d');
  new Chart(ctxBarrasErrores, {
    type: 'bar',
    data: { labels: servidoresErrores, datasets: [{ label: 'Errores totales', data: erroresTotales }] },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: { x: { title: { display: true, text: 'Cantidad de errores' } }, y: { title: { display: true, text: 'Servidor' } } }
    }
  });

  const ctxCpuProm = document.getElementById('chartCpuPromedio').getContext('2d');
  new Chart(ctxCpuProm, {
    type: 'bar',
    data: { labels: servidoresCpu, datasets: [{ label: 'CPU promedio (%)', data: cpuPromedios }] },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'CPU promedio (%)' } },
        x: { title: { display: true, text: 'Servidor' } }
      }
    }
  });

  const ctxEstados = document.getElementById('chartEstados').getContext('2d');
  new Chart(ctxEstados, {
    type: 'doughnut',
    data: { labels: estadosLabels, datasets: [{ data: estadosCounts }] },
    options: { plugins: { legend: { position: 'bottom' } } }
  });

  const ctxErroresTiempo = document.getElementById('chartErroresTiempo').getContext('2d');
  new Chart(ctxErroresTiempo, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Errores', data: erroresData, tension: 0.3 },
        { label: 'Memoria (%)', data: memoriaData, tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true, title: { display: true, text: 'Errores / Memoria (%)' } } }
    }
  });
</script>
{% endblock %}
